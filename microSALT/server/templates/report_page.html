{% extends 'layout.html' %}
  {% block body %}
    {% set thres = dict() %}
      <div class="container-fluid">
        <div class="col-lg-16">
          <!-- Summary pages  -->
          <footer>
            <div class="panel"><div class="panel-body">
              <a href="https://github.com/Clinical-Genomics/microSALT"><img src="https://github.com/Clinical-Genomics/microSALT/blob/master/artwork/microsalt.jpg?raw=true" alt="MicroSALT Logo" align="left" style="position:absolute;left:15px;width:400px;height:100px;display:flex;"></a>
              <!--<img src="swedac.jpg" alt="Swedac Logo" align="right" style="display:flex;">-->
              <h2 class="page-header">
                <small><br><br>Clinical Microbiology</small>
              <small><p align="right">{{date}}</p></small></h2>



              <div class="row">
                <div class="col-sm-6">
                  <div class="card">
                    <div class="card-body">
                      <h3 class="card-title">Kontakt Clinical genomics:</h3>
                      <address>
                        <strong>Clinical Genomics</strong><br>
                        Science for Life Laboratory<br>
                        Tomtebodavägen 23<br>
                        171 65 Solna<br>
                        <abbr title="Phone">P:</abbr> (08) 524 81 500
                      </address>
                    </div>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="card">
                    <div class="card-body">
                      <h3 class="card-title">Kund: </h3>
                      <address>
                        <h2>{{samples[0].projects.Customer_ID}}</h2><br>


                      </address>
                    </div>
                  </div>
                </div>
              </div>
              <br />

              <div class="card">
                <div class="card-block">
                  <h3 class="card-title">Project Summary</h3>
                    <div class="table-responsive"><table class="table table-bordered" style='table-layout:fixed;'>
                          <tr>
                          <td><b>Project ID <i>(CG Project ID)</i></b>
                            <td>{{samples[0].projects.Customer_ID_project}} <i>({{samples[0].projects.CG_ID_project}})</i></td>
                          </tr>
                          <tr>
                          <td><b>Customer ID <i>(CG Project ID)</i></b>
                            <td>{{samples[0].projects.Customer_ID}}<i></i></td>
                          </tr>
                          <tr>
                            <td><b>Analysis date</b></td>
                            <td>{{samples[0].date_analysis.date()}}</td>
                          </tr>
                          <tr>
                            <td><b>Pipeline version</b></td>
                            <td>{{build}}</td>
                          </tr>
                        </table>
                      </div>
                </div>



                <div class="card-block">
                  <h3 class="card-title">Sample Summary</h3>
                  <div class="table-responsive">
                    <table  class="table table-bordered" style='table-layout:fixed;'>
                  <tr>
                    <th>Sample ID</th>
                    <th>CG Sample ID</th>
                    <th>Applikations tag</th>
                    <th>Ankomstdatum</th>
                    <th>Biblioteksprep datum</th>
                    <th>Biblioteksmetod</th>
                    <th>Sekvensering datum</th>
                    <th>Sekvenseringsmetod</th>
                    <th>Priority(research/standard)</th>
                  </tr>
                  {% for sample in samples %}
                    <tr>
                      <td>{{sample.Customer_ID_sample}}</td>
                      <td>{{sample.CG_ID_sample}}</td>
                      <td>{{sample.application_tag}}</td>
                      <td>{{samples[0].projects.date_ordered.date()}}</td>
                      <td>*</td>
                      <td>*</td>
                      <td>*</td>
                      <td>*</td>
                      <td>*</td>
                      </tr>
                      {% endfor %}
                  </table>
                </div>
              </div>
            </div>

            </footer>



            <footer>
              <div class="panel"><div class="panel-body">
                <h3><strong>Summary of Results</strong><br></h3>
                <div class="table-responsive">
                  <table  class="table table-bordered" style='table-layout:fixed;'>
                    <tr>
                      <th>Sample ID</th>
                      <th>CG Sample ID</th>
                      <th>Organism</th>
                      <th>Sequence Type</th>
                      <th>Thresholds</th>
                    </tr>
                    {% for sample in samples %}
                      <tr>
                        <td>{{sample.Customer_ID_sample}}</td>
                        <td>{{sample.CG_ID_sample}}</td>
                        {% if sample.organism is not none %}
                          <td><i>{{sample.organism.replace('_', ' ').capitalize()}}</i></td>
                          {% else %}
                          <td><i>Control</i></td>
                          {% endif %}
                          {% if sample.ST_status == 'None' or sample.ST == -1 %}
                          <td><font color="red">{{ sample.ST_status }}</font></td>
                          {% elif sample.ST <= -4 %}
                          <td>{{sample.ST}} (Novel)</td>
                          {% else %}
                          <td>{{sample.ST_status }}</td>
                          {% endif %}
                          {% if sample.threshold == 'Failed' %}
                          <td><font color="red">{{sample.threshold }}</font></td>
                          {% else %}
                          <td>{{sample.threshold }}</td>
                          {% endif %}
                        </tr>
                        {% endfor %}
                      </table>
                    </div>
                  </div>
                </div>
              </footer>
          <!-- Sample pages -->
          {% for sample in samples %}
            <footer>
              <div class="panel">
                <div class="panel-body">
                  <h2 class="page-header"><div class="row"></div><strong>microSALT Results</strong><br>
                    <small>Clinical Microbiology</small>
                    <small><p align="right">{{date}}</p></small></h2>

                   <div class="table-responsive"><table class="table table-bordered" style='table-layout:fixed;'>
                    <h4>Overview</h4>
                    <tr>
                      <td><b>Project ID <i>(CG Project ID)</i></b></td>
                      <td>{{sample.projects.Customer_ID_project}} <i>({{sample.projects.CG_ID_project}})</i></td>
                    </tr>
                    <tr>
                      <td><b>Sample ID <i>(CG Sample ID)</i></b></td>
                      <td>{{sample.Customer_ID_sample}}  <i>({{sample.CG_ID_sample}})</i></td>
                    </tr>
                    <tr>
                      <th scope="row" >Analysis date</th>
                      <td>{{sample.date_analysis.date()}}</td>
                    </tr>
                    <tr>
                      <th scope="row" >Organism</th>
                      {% if sample.organism is not none %}
                        <td><i>{{sample.organism.replace('_', ' ').capitalize()}}</i></td>
                      {% else %}
                        <td><i>Control</i></td>
                      {% endif %}
                    </tr>
                    <tr><th scope="row" >Sequence Type</th>
                      {% if sample.ST_status == 'None' %}
                        <td><font color="red">{{sample.ST_status }}</font></td>
                      {% elif sample.ST <= -4 %}
                        <td>{{sample.ST}} (Novel)</td>
                      {% else %}
                        <td>{{sample.ST_status }}</td>
                      {% endif %}
                    </tr>
                    <tr><th scope="row" >Thresholds</th>
                      {% if sample.threshold=='Failed' %}
                        <td><font color="red">{{sample.threshold }}</font></td>
                      {% else %}
                        <td>{{sample.threshold }}</td>
                      {% endif %}
                    </tr>
                    {% if sample.organism in version %}
                      <tr>
                        <th scope="row">Reference version</th>
                        <td>{{version[sample.organism]}}</td>
                      </tr>
                    {% endif %}
                    {% if sample.priority is not none %}
                      <tr>
                        <th scope="row">Priority</th>
                        <td>{{sample.priority}}</td>
                      </tr>
                    {% endif %}
                  </table></div>

                <div class="table-responsive"><table class="table table-bordered" style='table-layout:fixed;'>
                  <h4>Assembly</h4>
                  {% if sample.genome_length > -1 %}
                    <tr><th scope="row" >Estimated genome length</th><td>{{'{0:,}'.format(sample.genome_length)|replace(","," ")}}</td></tr>
                    <tr><th scope="row" >GC content</th><td>{{sample.gc_percentage| round(2)}}%</td></tr>
                    <tr><th scope="row" >N50 (min. contig length for 50% of genome)</th><td>{{'{0:,}'.format(sample.n50)|replace(","," ")}}</td></tr>
                    <tr><th scope="row" >Necessary contigs</th><td>{{sample.contigs}}</td></tr>
                  {% else %}
                    <tr><th scope="row" >Estimated genome length</th><td>Insufficient data for QUAST</td></tr>
                    <tr><th scope="row" >GC content</th><td>Insufficient data for QUAST</td></tr>
                    <tr><th scope="row" >N50 (min. contig length for 50% of genome)</th><td>Insufficient data for QUAST</td></tr>
                    <tr><th scope="row" >Necessary contigs</th><td>Insufficient data for QUAST</td></tr>
                  {% endif %}
                </table></div>

                </div>
              </div>
            </footer>
          {% if sample.genome_length > -1 %}

            <footer>
              <div class="panel">
              <div class="panel-body">

                <div class="table-responsive">
                  {% if not sample.seq_types|length == 0 and 'Invalid' not in sample.ST_status%}
                    <table  class="table table-bordered" style='table-layout:fixed;'>
                      <h4>MLST</h4>
                      <thead>
                        <tr>
                          <th width="4%">#</th>
                          <th width="30%">Loci</th>
                          <th width="20%">Allele</th>
                          <th width="20%">Contig Coverage</th>
                          <th>Identity</th>
                          <th>Span</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for seq_type in sample.seq_types if seq_type.st_predictor%}
                            <tr>
                              <td>{{loop.index}}</td>
                              <td>{{seq_type.loci}}</td>
                              <td> {{ seq_type.allele}}</td>
                              <td>{{ seq_type.contig_coverage|round(2)  }}</td>
                              <td>{{ seq_type.identity|round(2) }}</td>
                              <td>{{ seq_type.span|round(2) }}</td>
                            </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% endif %}
                </div>

                <div class="table-responsive">
                  {% if not sample.resistances|length == 0 %}
                    <table  class="table table-bordered" style='table-layout:fixed;'>
                    <h4>Resistance</h4>
                      <thead>
                        <tr>
                          <th width="4%">#</th>
                          <th width="15%">Gene</th>
                          <th width="20%">Type</th>
                          <th width="15%">Reference</th>
                          <th width="20%">Contig Coverage</th>
                          <th>Identity</th>
                          <th>Span</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for seq_type in sample.resistances if seq_type.threshold == 'Passed' %}
                            <tr>
                              <td>{{loop.index}}</td>
                              <td>{{seq_type.gene}}</td>
                              {% if seq_type.resistance is not none %}
                                <td>{{seq_type.resistance|title}}</td>
                              {% else %}
                                <td>{{seq_type.instance|title}}</td>
                              {% endif %}
                              {% if seq_type.reference is not none %}
                                <td>{{seq_type.reference}}</td>
                              {% else %}
                                <td>Unknown</td>
                              {% endif %}
                              <td>{{ seq_type.contig_coverage|round(2)  }}</td>
                              <td>{{ seq_type.identity|round(2) }}</td>
                              {% if seq_type.span == 999.0 %}
                                <td>Undef.</td>
                              {% else %}
                                <td>{{ seq_type.span|round(2) }}</td>
                              {% endif %}
                            </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% endif %}
                </div>

              </div>
              </div>
            </footer>
          {% endif %}
          {% endfor %}

          <footer>
            <div class="panel"><div class="panel-body">

              <h3><strong>Teknisk beskrivning av analysen : {{samples[0].application_tag}}</strong><br></h3>
              <p>
                Microbial whole genome routine samples, Nextera prep, Sequencing on HiSeq X to 3 M read pairs<br>

              </p>

              <h3><strong>Begränsningar av analysen : {{samples[0].application_tag}}</strong><br></h3>
              <p>
                <br>

              </p>

              <h3><strong>Signatur för godkännande av rapport</strong><br></h3>
              <p>
                Valtteri Wirta<br>
                Head of unit, Clinical Genomics
              </p>

              <div class="text-muted text-center">Slut på rapport</div>


            </div>
            </div>
          </footer>


        </div>
      </div>
  {% endblock %}
