{% extends 'layout.html' %}
  {% block body %}
    {% set thres = dict() %}
      <div class="container-fluid">
        <div class="col-lg-16">
          <!-- Summary pages  -->
          <footer>
            <div class="panel"><div class="panel-body">
              <a href="https://github.com/Clinical-Genomics/microSALT">
              <img src="https://github.com/Clinical-Genomics/microSALT/blob/master/artwork/microsalt.jpg?raw=true" \
              alt="MicroSALT Logo" align="left" \
              style="position:absolute;left:15px;width:400px;height:100px;display:flex;"></a>
              <!--<img src="swedac.jpg" alt="Swedac Logo" align="right" style="display:flex;">-->
              <img src="https://github.com/Clinical-Genomics/microSALT/blob/accreditation-changes-to-report/artwork/swedac.jpg?raw=true" alt="Swedac Logo" align="right" style="display:flex;">
              <h2 class="page-header">
                <small><br><br><br>Typningsrapport</small>
              <small><p align="center">Rapport genererad: {{date}}</p></small></h2>
              <div class="row">
                <div class="col">
                 <h3>Kontakt Clinical Genomics</h3>
                 <address>
                   <strong>Clinical Genomics</strong><br>
                   Science for Life Laboratory<br>
                   Tomtebodavägen 23<br>
                   171 65 Solna<br>
                  <abbr title="Phone">P:</abbr> (08) 524 81 500
                 </address>
              </div>
               <div class="col">
                 <h3>Kund:</h3>
                 <address>
                 <h2>{{samples[0].projects.Customer_ID}}</h2><br>
                </address>
              </div>
              <br />
              <br />

              <div class="panel"><div class="panel-body">
                <h3>Projektsammanställning<br></h3>
                    <div class="table-responsive"><table class="table table-bordered" style='table-layout:fixed;'>
                      <tr>
                      <td><b>Ticket ID <i>(CG Projekt ID)</i></b>
                        <td>{{samples[0].projects.Customer_ID_project}} <i>({{samples[0].projects.CG_ID_project}})</i></td>
                      </tr>
                      <tr>
                      <td><b>Kund ID (*)</b>
                        <td>{{samples[0].projects.Customer_ID}}<i></i></td>
                      </tr>
                      <tr>
                        <td><b>microSALT version</b></td>
                        <td>{{build}}</td>
                      </tr>
                    </table></div>
              </div></div>

              <div class="panel"><div class="panel-body">
                <h3>Provsammanställning<br></h3>
                  <div class="table-responsive">
                    <table  class="table table-bordered" style='table-layout:fixed;'>
                      <tr>
                        <th>Prov ID (*)</th>
                        <th>Applikationstag (*)</th>
                        <th>Organism (*)</th>
                        <th>Ankomstdatum</th>
                        <th>Datum prep</th>
                        <th>Metod prep</th>
                        <th>Datum sekvensering</th>
                        <th>Metod sekvensering</th>
                        <th>Prioritet (*)(**)</th>
                        <th>Verifierad</th>
                      </tr>
                      {% for sample in samples %}
                        <tr>
                          <td>{{sample.Customer_ID_sample}}</td>
                          <td>{{sample.application_tag}}</td>
                          {% if sample.organism is not none %}
                            <td><i>{{sample.organism.replace('_', ' ').capitalize()}}</i></td>
                          {% else %}
                            <td><i>N/A</i></td>
                          {% endif %}
                          <td>{{samples[0].projects.date_ordered.date()}}</td>
                          {% if sample.date_libprep is not none %}
                            <td>{{sample.date_libprep.date()}}</td>
                          {% else %}
                            <td><i>Okänt</i></td>
                          {% endif %}
                          {% if sample.method_libprep is not none and 'Not in LIMS' not in sample.method_libprep %}
                            <td>{{sample.method_libprep}}</td>
                          {% else %}
                            <td><i>Okänt</i></td>
                          {% endif %}
                          {% if sample.date_sequencing is not none %}
                            <td>{{sample.date_sequencing.date()}}</td>
                          {% else %}
                            <td><i>Okänt</i></td>
                          {% endif %}
                          {% if sample.method_sequencing is not none and 'Not in LIMS' not in sample.method_sequencing %}
                            <td>{{sample.method_sequencing}}</td>
                          {% else %}
                            <td><i>Okänt</i></td>
                          {% endif %}
                          <td>{{sample.priority.capitalize()}}</td>
                          {% if sample.priority == 'standard' %}
                            <td><i>✔︎</i></td>
                          {% else %}
                            <td><i>-</i></td>
                          {% endif %}
                        </tr>
                      {% endfor %}
                    </table>
                  </div>
                (*) Information om prover som kommer från kund <br/>
                (**) Standard = Verifierad organim,
                Research = Icke verifierad organism <br/>
                Kvalitetskontrollen har verifierats för ett antal bestämda organismer.
                För andra organismer kan ej kriterierna för metoden appliceras.
                </div>
            </div>
          </footer>


          <footer>
            <div class="panel"><div class="panel-body">
              <h3>Resultatsammanställning(***)<br></h3>
              <p>
              (***) Laboratoriet har inte haft ansvar för provtagningsstadiet och
              extraktion, resultaten gäller för provet såsom det har mottagits.
              </p>
              <div class="table-responsive">
                <table  class="table table-bordered" style='table-layout:fixed;'>
                  <tr>
                    <th>Prov ID(*)</th>
                    <th>CG Prov ID</th>
                    <th>Organism (*)</th>
                    <th>Sekvenstyp</th>
                    <th>Tröskelvärden</th>
                  </tr>
                  {% for sample in samples %}
                    <tr>
                      <td>{{sample.Customer_ID_sample}}</td>
                      <td>{{sample.CG_ID_sample}}</td>
                      {% if sample.organism is not none %}
                        <td><i>{{sample.organism.replace('_', ' ').capitalize()}}</i></td>
                        {% else %}
                        <td><i>Kontroll</i></td>
                      {% endif %}
                      {% if sample.ST_status == 'None' or sample.ST == -1 %}
                        <td><font color="red">{{ sample.ST_status }}</font></td>
                      {% elif sample.ST <= -4 %}
		        <td>{{sample.ST}} (Novel)</td>
		      {% else %}
		        <td>{{sample.ST_status }}</td>
		      {% endif %}
		      {% if sample.threshold == 'Failed' %}
		        <td><font color="red">Underkända</font></td>
                      {% elif sample.threshold == '-' %}
                        <td><font color="red">-</font></td>
		      {% else %}
		        <td>Godkända</td>
		      {% endif %}
	            </tr>
		  {% endfor %}
	        </table>
	      </div>
	    </div></div>
          </footer>

          <footer>
            <div class="panel"><div class="panel-body">

              <h3><strong>Teknisk beskrivning av analysen : {{samples[0].application_tag}}</strong><br></h3>
              <p>
              Mikrobiell helgenomssekvensering av rutinprov, med krav på minst 3 miljoner läspar.
              Nextera library preparation.
              <br></p>

              <h3><strong>Begränsningar av analysen : {{samples[0].application_tag}}</strong><br></h3>
              <p>
              Analysen kan enbart beställas av gruppen Klinisk Mikrobiologi.
              Typningen utgår från de publikt tillgängliga databaserna pubMLST och resFinder.
              Typningen av prover är enbart att anses som tillförlitlig om desamma uppnår de fördefinierade tröskelvärdena.
              Uppnåelse av tröskelvärdena garanteras i sin tur enbart för prover vars förhantering och detaljer tidigare verifierats av personal på Clinical Genomics.
              </p>

              <h3><strong>Avvikelser från metoden</strong><br></h3>
              <p>
              All kommunikation gällande order såsom tillägg, avvikelser eller
              ev undantag i metoden från Clinical Genomics finns tillgängligt i
              SupportSystem för dess ticket id. En stängd ticket kan närsomhelst
              öppnas upp igen för frågor.
              </p>

              <h3><strong>Signatur för godkännande av rapport</strong><br></h3>
              <p>
                Valtteri Wirta<br>
                Head of unit, Clinical Genomics
              </p>


            </div>
            </div>
          </footer>


          <!-- Sample pages -->
          {% for sample in samples %}
            <footer>
              <div class="panel">
        	<div class="panel-body">
        	  <h2 class="page-header"><div class="row"></div><strong>Detaljresultat</strong>
                  {% if sample.priority == 'standard' %}
                    <img src="https://github.com/Clinical-Genomics/microSALT/blob/accreditation-changes-to-report/artwork/swedac.jpg?raw=true" alt="Swedac Logo" \
                    align="right" style="width:40px;height:60px;display:flex;">
                  {% else %}
                    <p align="right">Icke verifierad organism</p>
                  {% endif %}
                  <br>
                  <small>Klinisk Mikrobiologi</small>
                  <small><p align="center">Rapport genererad: {{date}}</p></small></h2>
        	  <div class="table-responsive"><table class="table table-bordered" style='table-layout:fixed;'>
        	    <h4>Översikt</h4>
        	    <tr>
        	      <td><b>Ticket ID <i>(CG Projekt ID)</i></b></td>
        	      <td>{{sample.projects.Customer_ID_project}} <i>({{sample.projects.CG_ID_project}})</i></td>
        	    </tr>
        	    <tr>
        	      <td><b>Prov ID <i>(CG Prov ID)</i></b></td>
        	      <td>{{sample.Customer_ID_sample}}  <i>({{sample.CG_ID_sample}})</i></td>
        	    </tr>
        	    <tr>
        	      <th scope="row" >Analys datum</th>
        	      <td>{{sample.date_analysis.date()}}</td>
        	    </tr>
        	    <tr>
        	      <th scope="row" >Organism</th>
        	      {% if sample.organism is not none %}
        		<td><i>{{sample.organism.replace('_', ' ').capitalize()}}</i></td>
        	      {% else %}
        		<td><i>Okänd</i></td>
        	      {% endif %}
        	    </tr>
        	    <tr><th scope="row" >Sekvenstyp</th>
        	      {% if sample.ST_status == 'None' %}
        		<td><font color="red">{{sample.ST_status }}</font></td>
        	      {% elif sample.ST <= -4 %}
        		<td>I{{sample.ST|int|abs}} (Novel)</td>
        	      {% else %}
        		<td>{{sample.ST_status }}</td>
        	      {% endif %}
        	    </tr>
        	    <tr><th scope="row" >Tröskelvärden</th>
        	      {% if sample.threshold=='Failed' %}
        		<td><font color="red">Underkända</font></td>
                      {% elif sample.threshold == '-' %}
                        <td><font color="red">-</font></td>
        	      {% else %}
        		<td>Godkända</td>
        	      {% endif %}
        	    </tr>
        	    {% if sample.organism in version and sample.organism is not none %}
        	      <tr>
        		<th scope="row">Referensversion</th>
        		<td>{{version[sample.organism]}}</td>
        	      </tr>
        	    {% endif %}
        	    {% if sample.priority is not none %}
        	      <tr>
        		<th scope="row">Prioritet</th>
        		<td>{{sample.priority.capitalize()}}</td>
        	      </tr>
        	    {% endif %}
        	  </table></div>
        	<div class="table-responsive"><table class="table table-bordered" style='table-layout:fixed;'>
        	<h4>Assembly</h4>
        	{% if sample.genome_length > -1 %}
        	      <tr><th scope="row" >Förväntad genomstorlek</th><td>{{'{0:,}'.format(sample.genome_length)|replace(","," ")}}</td></tr>
        	      <tr><th scope="row" >GC halt</th><td>{{sample.gc_percentage| round(2)}}%</td></tr>
        	      <tr><th scope="row" >N50 (minsta contiglängd för 50% av genomet)</th><td>{{'{0:,}'.format(sample.n50)|replace(","," ")}}</td></tr>
        	      <tr><th scope="row" >Nödvändiga contigs</th><td>{{sample.contigs}}</td></tr>
        	{% else %}
                  <i>Assemblydata saknas</i>
        	{% endif %}
                </table></div>
        	</div>

                {% if sample.genome_length > -1 %}
                  <div class="panel"><div class="panel-body">
                  <h4>MLST</h4>
                  <h6>Identitetströskel: {{threshold.mlst_id}}%, Längdtröskel: {{(threshold.mlst_span*100)|round(2)}}%, Novel misstankströskel: {{threshold.mlst_novel_id}}%</h6>
                  <div class="table-responsive"><table  class="table table-bordered" style='table-layout:fixed;'>
                  {% if not sample.seq_types|length == 0 and 'saknas' not in sample.ST_status%}
                    <tr>
                      <th width="4%">#</th>
                      <th width="30%">Loci</th>
                      <th width="20%">Allel</th>
                      <th width="20%">Kmer Täckning</th>
                      <th>Identitet %</th>
                      <th>Längd (HSP) %</th>
                    </tr>
                  {% for seq_type in sample.seq_types if seq_type.st_predictor%}
                    <tr>
                      <td>{{loop.index}}</td>
                      <td>{{seq_type.loci}}</td>
                      <td>{{seq_type.allele}}</td>
                      <td>{{seq_type.contig_coverage|round(2)}}x</td>
                      <td>{{seq_type.identity|round(2)}}%</td>
                      <td>{{(seq_type.span*100)|round(2)}}%</td>
                    </tr>
                  {% endfor %}
                  </table>
                  {% else %}
                    
                    <i>MLST data saknas</i>
                  {% endif %}
                  </div>

                  <div class="table-responsive">
                    <table  class="table table-bordered" style='table-layout:fixed;'>
                    <h4>Resistenser</h4>
                    <h6>Identitetströskel: {{threshold.motif_id}}%, Längdtröskel: {{(threshold.motif_span*100)|round(2)}}%</h6>
                    {% if not sample.resistances|selectattr('threshold', 'equalto', 'Passed')|list|length == 0 %}
                        <tr>
                          <th width="4%">#</th>
                          <th width="15%">Gen</th>
                          <th width="20%">Grupp</th>
                          <th width="15%">Referens</th>
                          <th width="20%">Kmer Täckning</th>
                          <th>Identitet %</th>
                          <th>Längd (HSP) %</th>
                        </tr>
                        {% for seq_type in sample.resistances if seq_type.threshold == 'Passed' %}
                          <tr>
                           <td>{{loop.index}}</td>
                            <td>{{seq_type.gene}}</td>
                            {% if seq_type.resistance is not none %}
                              <td>{{seq_type.resistance|title}}</td>
                            {% else %}
                              <td>{{seq_type.instance|title}}</td>
                            {% endif %}
                            {% if seq_type.reference is not none %}
                              <td>{{seq_type.reference}}</td>
                            {% else %}
                              <td>Okänd</td>
                            {% endif %}
                            <td>{{seq_type.contig_coverage|round(2) }}x</td>
                            <td>{{seq_type.identity|round(2) }}%</td>
                            {% if seq_type.span == 999.0 %}
                              <td>Odefinierad</td>
                            {% else %}
                              <td>{{(seq_type.span*100)|round(2) }}%</td>
                            {% endif %}
                          </tr>
                        {% endfor %}
                    </table>
                    {% else %}
                      <i>Resistensdata saknas</i>
                    {% endif %}
                  </div>
                {% endif %}
                </div>
              </div>
            </footer>
          {% endfor %}
          <div class="text-muted text-center">Slut på rapport</div>
        </div>
      </div>
  {% endblock %}
